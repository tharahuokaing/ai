<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huokaingthara Sentient OS v6.0</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        :root { --neon: #00ff41; --dim: #004411; --bg: #050505; }
        body { background: var(--bg); color: var(--neon); font-family: 'Courier New', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar { width: 360px; border-right: 2px solid var(--neon); display: flex; flex-direction: column; padding: 20px; background: rgba(0,15,0,0.95); z-index: 10; box-shadow: 10px 0 20px rgba(0,0,0,0.5); }
        #chat-output { flex-grow: 1; overflow-y: auto; margin-bottom: 15px; padding: 10px; border: 1px solid var(--dim); background: rgba(0,0,0,0.7); scroll-behavior: smooth; }
        
        .user-msg { color: #fff; margin: 10px 0; font-size: 0.85em; opacity: 0.8; }
        .ai-msg { color: var(--neon); margin-bottom: 20px; padding-left: 10px; border-left: 3px solid var(--neon); text-shadow: 0 0 8px var(--neon); }
        
        .control-panel { display: flex; flex-direction: column; gap: 10px; }
        .input-group { display: flex; gap: 5px; }
        input[type="text"] { background: #000; border: 1px solid var(--neon); color: var(--neon); padding: 12px; outline: none; flex-grow: 1; }
        
        button { background: #000; border: 1px solid var(--neon); color: var(--neon); cursor: pointer; transition: 0.3s; padding: 10px; }
        button:hover { background: var(--neon); color: #000; }
        #mic-btn.active { background: red; color: white; animation: pulse 1s infinite; }

        .file-input { font-size: 10px; margin-top: 10px; color: #888; }
        #visualizer { flex-grow: 1; background: #000; cursor: crosshair; }
        .status-tag { font-size: 0.7em; letter-spacing: 1px; margin-bottom: 10px; color: yellow; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="status-tag" id="sys-status">SINGULARITY: STANDBY</div>
    <h2 style="margin: 0 0 20px 0; text-align: center;">SENTIENT CORE</h2>
    
    <div id="chat-output"></div>
    
    <div class="control-panel">
        <div class="input-group">
            <input type="text" id="userInput" placeholder="Query neural pathways..." autocomplete="off">
            <button id="mic-btn">ðŸŽ¤</button>
        </div>
        
        <div class="file-input">
            <label>TRAIN VIA CSV:</label><br>
            <input type="file" id="csvLoader" accept=".csv" style="width: 100%;">
        </div>

        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <button onclick="downloadBrain()" style="flex:1; font-size: 10px;">SAVE BRAIN</button>
            <button onclick="clearMemory()" style="flex:1; font-size: 10px; border-color: red; color: red;">WIPE</button>
        </div>
    </div>
    <div style="font-size: 0.7em; margin-top: 15px; opacity: 0.5;" id="stats">Pathways: 0</div>
</div>

<svg id="visualizer"></svg>

<script>
    let brain = {};
    let isLearning = false;
    let lastQuery = "";

    // --- 1. SPEECH ENGINE ---
    const micBtn = document.getElementById('mic-btn');
    const recognition = window.SpeechRecognition || window.webkitSpeechRecognition ? new (window.SpeechRecognition || window.webkitSpeechRecognition)() : null;
    const synth = window.speechSynthesis;

    if (recognition) {
        recognition.lang = 'km-KH'; // Supports Khmer or switch to 'en-US'
        micBtn.onclick = () => { recognition.start(); micBtn.classList.add('active'); };
        recognition.onresult = (e) => {
            const text = e.results[0][0].transcript;
            document.getElementById('userInput').value = text;
            processInput(text);
        };
        recognition.onend = () => micBtn.classList.remove('active');
    }

    function speak(text) {
        if (!synth) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.pitch = 1; utter.rate = 1;
        synth.speak(utter);
    }

    // --- 2. CSV MACHINE LEARNING INGESTION ---
    document.getElementById('csvLoader').onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(event) {
            const rows = event.target.result.split('\n');
            rows.forEach(row => {
                const parts = row.split(',');
                if (parts.length >= 2) {
                    brain[parts[0].trim().toLowerCase()] = parts[1].trim();
                }
            });
            saveBrain();
            addLog("AI: Neural database updated via CSV.", "ai-msg");
        };
        reader.readAsText(file);
    };

    // --- 3. CORE INTELLIGENCE (FUZZY LOGIC) ---
    function getSimilarity(s1, s2) {
        let longer = s1.toLowerCase(), shorter = s2.toLowerCase();
        if (s1.length < s2.length) [longer, shorter] = [shorter, longer];
        if (longer.length === 0) return 1.0;
        return (longer.length - editDistance(longer, shorter)) / parseFloat(longer.length);
    }

    function editDistance(s1, s2) {
        let costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let lastValue = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i === 0) costs[j] = j;
                else if (j > 0) {
                    let newValue = costs[j - 1];
                    if (s1.charAt(i - 1) !== s2.charAt(j - 1))
                        newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                    costs[j - 1] = lastValue;
                    lastValue = newValue;
                }
            }
            if (i > 0) costs[s2.length] = lastValue;
        }
        return costs[s2.length];
    }

    // --- 4. SYSTEM LOGIC ---
    function saveBrain() {
        localStorage.setItem('huokaingthara_v6', JSON.stringify(brain));
        updateUI();
    }

    function addLog(text, className) {
        const out = document.getElementById('chat-output');
        out.innerHTML += `<div class="${className}">${text}</div>`;
        out.scrollTop = out.scrollHeight;
    }

    function processInput(q) {
        addLog(`> ${q}`, "user-msg");
        
        if (isLearning) {
            brain[lastQuery.toLowerCase()] = q;
            saveBrain();
            addLog(`AI: Pathway established. Learning complete.`, "ai-msg");
            speak("ážšáŸ€áž“ážšáž½áž…ážšáž¶áž›áŸ‹");
            isLearning = false;
            document.getElementById('sys-status').innerText = "SINGULARITY: STABLE";
            return;
        }

        let bestMatch = null, maxScore = 0;
        for (let key in brain) {
            let score = getSimilarity(q, key);
            if (score > maxScore) { maxScore = score; bestMatch = key; }
        }

        if (maxScore > 0.45) {
            const res = brain[bestMatch];
            addLog(`AI: ${res}`, "ai-msg");
            speak(res);
        } else {
            addLog(`AI: Pattern unknown. Provide definition for "${q}":`, "ai-msg");
            speak("ážŸáž¼áž˜áž‡áž½áž™áž”áž„áŸ’ážšáŸ€áž“ážáŸ’áž‰áž»áŸ†");
            isLearning = true;
            lastQuery = q;
            document.getElementById('sys-status').innerText = "SINGULARITY: EVOLVING...";
        }
    }

    document.getElementById('userInput').onkeypress = (e) => {
        if (e.key === 'Enter') { processInput(e.target.value); e.target.value = ""; }
    };

    function downloadBrain() {
        const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(brain, null, 4));
        const link = document.createElement('a');
        link.setAttribute("href", data); link.setAttribute("download", "brain.json");
        link.click();
    }

    function clearMemory() { if(confirm("Wipe all neural pathways?")) { brain = {}; saveBrain(); location.reload(); } }

    function updateUI() {
        const count = Object.keys(brain).length;
        document.getElementById('stats').innerText = `Pathways: ${count}`;
        if(count > 500) document.getElementById('sys-status').innerText = "SINGULARITY: IMMINENT";
        updateGraph();
    }

    // --- 5. D3 VISUALIZER ---
    function updateGraph() {
        const svg = d3.select("#visualizer"), width = window.innerWidth - 360, height = window.innerHeight;
        svg.selectAll("*").remove();
        const nodes = [{id:"CORE", group:1}], links = [];
        Object.keys(brain).slice(-80).forEach(k => {
            nodes.push({id:k, group:2});
            links.push({source:"CORE", target:k});
        });
        const sim = d3.forceSimulation(nodes).force("link", d3.forceLink(links).id(d=>d.id))
            .force("charge", d3.forceManyBody().strength(-120)).force("center", d3.forceCenter(width/2, height/2));
        const l = svg.append("g").selectAll("line").data(links).enter().append("line").attr("stroke", "#002200");
        const n = svg.append("g").selectAll("circle").data(nodes).enter().append("circle")
            .attr("r", d=>d.group===1?10:4).attr("fill", d=>d.group===1?"#ff0000":"#00ff41");
        sim.on("tick", () => {
            l.attr("x1", d=>d.source.x).attr("y1", d=>d.source.y).attr("x2", d=>d.target.x).attr("y2", d=>d.target.y);
            n.attr("cx", d=>d.x).attr("cy", d=>d.y);
        });
    }

    window.onload = async () => {
        const saved = localStorage.getItem('huokaingthara_v6');
        if (saved) brain = JSON.parse(saved);
        else {
            try { const res = await fetch('brain.json'); brain = await res.json(); } catch(e) {}
        }
        updateUI();
    };
</script>
</body>
    </html>
